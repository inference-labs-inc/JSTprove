name: Build and Publish to PyPI

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  build-wheels:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    permissions:
      contents: write
      id-token: write
    steps:
      - uses: actions/checkout@v5

      - name: Install uv
        uses: astral-sh/setup-uv@v6

      - name: Set up Python
        run: uv python install 3.10

      - name: Extract version from tag
        id: get_version
        shell: bash
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_underscore=$(echo $VERSION | tr '.' '-')" >> $GITHUB_OUTPUT

      - name: Update versions in config files
        run: |
          python -c "
          import re
          with open('pyproject.toml', 'r') as f:
              content = f.read()
          content = re.sub(r'version = \"[^\"]*\"', 'version = \"${{ steps.get_version.outputs.version }}\"', content, count=1)
          content = re.sub(r'onnx_generic_circuit_[0-9-]*', 'onnx_generic_circuit_${{ steps.get_version.outputs.version_underscore }}', content)
          with open('pyproject.toml', 'w') as f:
              f.write(content)
          with open('rust/jstprove_circuits/Cargo.toml', 'r') as f:
              content = f.read()
          content = re.sub(r'^version = \"[^\"]*\"', 'version = \"${{ steps.get_version.outputs.version }}\"', content, count=1, flags=re.MULTILINE)
          content = re.sub(r'name = \"onnx_generic_circuit_[^\"]*\"', 'name = \"onnx_generic_circuit_${{ steps.get_version.outputs.version_underscore }}\"', content)
          with open('rust/jstprove_circuits/Cargo.toml', 'w') as f:
              f.write(content)
          "
        shell: python

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-${{ hashFiles('**/Cargo.lock') }}

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libopenmpi-dev openmpi-bin pkg-config

      - name: Install system dependencies (macOS)
        if: runner.os == 'macOS'
        run: brew install open-mpi

      - name: Install system dependencies (Windows)
        if: runner.os == 'Windows'
        run: |
          choco install msmpi -y
          choco install msmpi-sdk -y

      - name: Build Rust binaries
        run: cargo build --release --bin onnx_generic_circuit_${{ steps.get_version.outputs.version_underscore }}

      - name: Copy binaries to package (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          mkdir -p python/core/binaries
          cp target/release/onnx_generic_circuit_${{ steps.get_version.outputs.version_underscore }} python/core/binaries/
          chmod +x python/core/binaries/onnx_generic_circuit_${{ steps.get_version.outputs.version_underscore }}

      - name: Copy binaries to package (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          mkdir -p python/core/binaries
          cp target/release/onnx_generic_circuit_${{ steps.get_version.outputs.version_underscore }}.exe python/core/binaries/

      - name: Build wheel
        run: uv build

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheel-${{ matrix.os }}
          path: ./dist/*.whl

  publish:
    needs: build-wheels
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Download all wheels
        uses: actions/download-artifact@v4
        with:
          pattern: wheel-*
          merge-multiple: true
          path: ./dist

      - name: Extract version from tag
        id: get_version
        shell: bash
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create GitHub Release with wheels
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ steps.get_version.outputs.version }}
          files: ./dist/*.whl

      - name: Install uv
        uses: astral-sh/setup-uv@v6

      - name: Publish to PyPI
        run: uv publish ./dist/*
