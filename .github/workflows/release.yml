name: Build and Publish to PyPI

on:
  push:
    tags:
      - "v*"
  pull_request:
  workflow_dispatch:

jobs:
  build-linux:
    if: >-
      github.event_name != 'pull_request' ||
      contains(github.event.pull_request.labels.*.name, 'test-build')
    runs-on: ubuntu-latest
    timeout-minutes: 60
    container:
      image: quay.io/pypa/manylinux_2_28_x86_64
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6

      - name: Install system dependencies
        run: |
          dnf install -y pkgconf-pkg-config perl-IPC-Cmd perl-Time-Piece clang-devel

      - name: Install Rust
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain nightly-2025-03-27
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install maturin
        run: pip3 install maturin

      - name: Extract version
        id: get_version
        shell: bash
        run: |
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION=$(grep -m1 '^version' pyproject.toml | sed 's/.*"\(.*\)".*/\1/')
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Update versions
        run: |
          sed -i '0,/^version = ".*"/{s/^version = ".*"/version = "${{ steps.get_version.outputs.version }}"/}' pyproject.toml
          sed -i '0,/^version = ".*"/{s/^version = ".*"/version = "${{ steps.get_version.outputs.version }}"/}' rust/jstprove_pyo3/Cargo.toml
          sed -i '0,/^version = ".*"/{s/^version = ".*"/version = "${{ steps.get_version.outputs.version }}"/}' rust/jstprove_circuits/Cargo.toml

      - name: Install Rust target
        run: rustup target add x86_64-unknown-linux-gnu

      - name: Cache Rust dependencies
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
            rust/jstprove_pyo3/target
            rust/jstprove_remainder/target
          key: manylinux-2-28-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            manylinux-2-28-cargo-

      - name: Build wheel
        run: maturin build --release --target x86_64-unknown-linux-gnu --manylinux 2_28

      - name: Test wheel installation
        run: |
          pip3 install target/wheels/*.whl
          python3 -c "from jstprove import Circuit; print('PyO3 bindings OK')"

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v6
        with:
          name: wheel-ubuntu-x86_64
          path: ./target/wheels/*.whl

  build-macos:
    if: >-
      github.event_name != 'pull_request' ||
      contains(github.event.pull_request.labels.*.name, 'test-build')
    runs-on: macos-latest
    timeout-minutes: 60
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Install maturin
        run: pip3 install maturin

      - name: Extract version
        id: get_version
        shell: bash
        run: |
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION=$(grep -m1 '^version' pyproject.toml | sed 's/.*"\(.*\)".*/\1/')
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Update versions
        run: |
          sed -i '' '1,/^version = /{s/^version = ".*"/version = "${{ steps.get_version.outputs.version }}"/;}' pyproject.toml
          sed -i '' '1,/^version = /{s/^version = ".*"/version = "${{ steps.get_version.outputs.version }}"/;}' rust/jstprove_pyo3/Cargo.toml
          sed -i '' '1,/^version = /{s/^version = ".*"/version = "${{ steps.get_version.outputs.version }}"/;}' rust/jstprove_circuits/Cargo.toml

      - name: Install Rust
        uses: dtolnay/rust-toolchain@nightly
        with:
          toolchain: nightly-2025-03-27

      - name: Install Rust target
        run: rustup target add aarch64-apple-darwin

      - name: Cache Rust dependencies
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
            rust/jstprove_pyo3/target
            rust/jstprove_remainder/target
          key: macos-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            macos-cargo-

      - name: Build wheel
        run: maturin build --release --target aarch64-apple-darwin
        env:
          MACOSX_DEPLOYMENT_TARGET: "11.0"

      - name: Test wheel installation
        run: |
          pip3 install target/wheels/*.whl
          python3 -c "from jstprove import Circuit; print('PyO3 bindings OK')"

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v6
        with:
          name: wheel-macos-aarch64
          path: ./target/wheels/*.whl

  publish:
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    needs: [build-linux, build-macos]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Download all wheels
        uses: actions/download-artifact@v7
        with:
          pattern: wheel-*
          merge-multiple: true
          path: ./dist

      - name: Extract version from tag
        id: get_version
        shell: bash
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create GitHub Release with wheels
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ steps.get_version.outputs.version }}
          files: ./dist/*.whl

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Publish to PyPI
        run: uv publish ./dist/*
