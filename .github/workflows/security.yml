name: Security Audit

on:
  schedule:
    - cron: "0 0 * * *" # Run daily at midnight
  push:
    branches: ["main", "rustfmt"]
    paths:
      - "**/Cargo.toml"
      - "**/Cargo.lock"
      - "pyproject.toml"
      - "uv.lock"
  pull_request:
    branches: ["main", "rustfmt"]
    paths:
      - "**/Cargo.toml"
      - "**/Cargo.lock"
      - "pyproject.toml"
      - "uv.lock"

jobs:
  rust-audit:
    name: Rust Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - uses: rustsec/audit-check@v2.0.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

  python-audit:
    name: Python Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install UV
        uses: astral-sh/setup-uv@v5

      - name: Install security tools
        run: |
          uv pip install --system safety bandit

      - name: Run safety check
        run: safety check

      - name: Run bandit
        id: bandit
        run: |
          set +e  # Don't exit on error

          bandit -r ./python --severity-level high -f json -o bandit-report.json
          BANDIT_EXIT_CODE=$?
          echo "exit_code=$BANDIT_EXIT_CODE" >> $GITHUB_OUTPUT

          # Also output to console for visibility
          echo "::group::Bandit Security Report"
          bandit -r ./python --severity-level high -f txt
          echo "::endgroup::"

          exit 0  # Continue to upload artifact

      - name: Upload security report
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: bandit-report.json

      - name: Check bandit results
        if: steps.bandit.outputs.exit_code != '0'
        run: |
          echo "Bandit found security issues. Please review the report."
          exit ${{ steps.bandit.outputs.exit_code }}
